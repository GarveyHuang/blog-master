function nextRecTop() {
    var rec = $("#RecentCommentsBlock");
    if (rec.length) {
        var top = rec.scrollTop();
        top++;
        rec.scrollTop(top);
        if (top != rec.scrollTop()) {
            rec.scrollTop(0)
        }
    }
};

function MobileComment() {
    var RecCommentTime = 80;
    var RecintervalId = setInterval(function () {
        nextRecTop()
    }, RecCommentTime);
    $("#RecentCommentsBlock").hover(function () {
        clearInterval(RecintervalId)
    }, function () {
        RecintervalId = setInterval(function () {
            nextRecTop()
        }, RecCommentTime)
    })
};

function addtbCommentBody_bg() {
    var tbcomment = $("#tbCommentBody");
    if (!tbcomment.hasClass("tbCommentBody_bg")) {
        tbcomment.addClass("tbCommentBody_bg");
        tbcomment.focus(function () {
            removetbCommentBody_bg()
        })
    }
};

function focusoutCommentBody_bg() {
    $("#tbCommentBody").focusout(function () {
        addtbCommentBody_bg()
    })
};

function removetbCommentBody_bg() {
    !$(".tbCommentBody_bg").removeClass("tbCommentBody_bg");
    $("#tbCommentBody").unbind("focus")
};

String.prototype.replaceAll = function (FindText, RepText) {
    regExp = new RegExp(FindText, "gm");
    return this.replace(regExp, RepText)
};

function resolveTitle(title) {
    var result;
    result = title.replaceAll(" ", "-");
    result = result.replaceAll("\\(", "");
    result = result.replaceAll("\\)", "");
    result = result.replaceAll("（", "");
    result = result.replaceAll("）", "");
    result = result.toLowerCase();
    return result
};

function GenerateContentList() {
    var nodes = $("#cnblogs_post_body :header");
    var content = '<a name="_labelTop"></a>';
    content += '<div id="navCategory">';
    content += '<blockquote><p style="font-size: 18pt; color:#a2b4ba"><b>目录</b></p>';
    content += "<div>";
    for (var i = 0; i < nodes.length; i++) {
        var item = "";
        var originTitle = $(nodes[i]).text();
        var resolvedTitle = resolveTitle(originTitle);
        if (nodes[i].tagName === "H1") {
            item = '<a style="font-size:18px" href="#' + resolvedTitle + '">' + $(nodes[i]).text() + "</a><br>"
        } else {
            if (nodes[i].tagName === "H2") {
                item = '<a style="font-size:16px" href="#' + resolvedTitle + '">&emsp;&emsp;' + $(nodes[i]).text() + "</a><br>"
            }
        }
        content += item;
    }
    content += "</blockquote></div>";
    var len = $("#cnblogs_post_body").length;
    if ($("#cnblogs_post_body").length != 0) {
        $($("#cnblogs_post_body")[0]).prepend(content)
    }
    $($("#cnblogs_post_body")[len - 1]).append("<div id='signature'><p>作者：<a href='localhost:56000'>旧情如烟</a></br>欢迎任何形式的转载，但请务必注明出处。</br>限于本人水平，如果文章和代码有表述不当之处，还请不吝赐教。</p></div>")
};

function generateTagClouds() {
    $(".catListTag>ul").wrap("<div class='wrap'></div>").parent().css({"width": "336px", "height": "240px"});
    var options = {
        "range": [-200, 300],
        "gravity": -10,
        "xPos": 0.5,
        "yPos": 0.5,
        "gravityVector": [0, 0, 1],
        "interval": 100,
        "hoverGravityFactor": 0
    };
    $("div.wrap").starfieldTagCloud(options)
};

function customTimer(inpId, fn) {
    if ($(inpId).length) {
        fn()
    } else {
        var intervalId = setInterval(function () {
            if ($(inpId).length) {
                clearInterval(intervalId);
                customTimer(inpId, fn)
            }
        }, 100)
    }
};

function RefreshPage() {
    return location.reload();
}

function PostNewComment(articleId, articleTitle) {
    //console.log(returnCitySN["cip"]+','+returnCitySN["cname"]);
    var author = $.trim($("#tbCommentAuthor").val());
    var content = $.trim($("#tbCommentBody").val());
    if (!content) {
        alert("请输入评论内容！");
        return
    }
    if (content.length > 4e3) {
        alert("评论内容过长，超过4000个字数限制！当前长度：" + content.length);
        return
    }
    if (articleId <= 0) {
        alert("articleId不正确");
        return
    }
    ShowCommentMsg("评论提交中...");
    $("#btn_comment_submit").attr("disabled", "disabled");
    //n = {};
    //n.blogApp = currentBlogApp;
    //n.articleId = articleId;
    //n.content = t;
    //i = $("#span_parentcomment_id").text();
    //n.parentCommentId = /(\d)/.test(i) ? i : 0;
    $.ajax({
        url: "/blog/comment/add",
        data: { articleId: articleId, content: content, author: author, articleTitle :articleTitle },
        type: "post",
        dataType: "json",
        timeout: 3e4,
        success: function (result) {
            if (result.code == 'success') {
                $("#btn_comment_submit").removeAttr("disabled");
                ShowCommentMsg("评论提交成功，感谢您的回复");
                $("#tbCommentBody").val("");
                cb_mathjax_render("#divCommentShow");
            }
            else {
                ShowCommentMsg("抱歉！评论提交失败！请与管理员联系(ishuangjw@foxmail.com)。");
                $("#btn_comment_submit").removeAttr("disabled");
            }
        },
        error: function (result) {
            result.code=="fail" ? ShowCommentMsg("抱歉！发生了错误！麻烦反馈至ishuangjw@foxmail.com"):$("#btn_comment_submit").removeAttr("disabled");
        }
    })
};

function ShowCommentMsg(n) {
    $("#tip_comment").html(n);
    $("#tip_comment2").html(n)
}

$(function () {
    customTimer("#div_digg", function () {
        var div_html = "<div class='' style='text-align: center'>&nbsp;<a href='#top'>顶部</a>&nbsp;|&nbsp;<a href='javascript:void(0);' onclick=\" $('#tbCommentBody').focus();\">评论</a></div>";
        $("#div_digg").append(div_html)
    });
    GenerateContentList();
    customTimer(".catListTag", generateTagClouds);
    MobileComment();
    customTimer("#tbCommentBody", function () {
        addtbCommentBody_bg();
        focusoutCommentBody_bg()
    })
});